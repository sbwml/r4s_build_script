From 30c7e8a14f796c38176fe444e1d9af5900eed783 Mon Sep 17 00:00:00 2001
From: Zac <zac@zacbowling.com>
Date: Mon, 19 Jan 2026 14:36:54 -0800
Subject: [PATCH 22/24] wifi: mt76: mt7925: improve error handling and code
 cleanup

Address suggestions from code review:

1. Remove redundant NULL check in mt7925_mcu_set_mlo_roc()
   The check for links[i].mconf and links[i].chan at line 1375 was
   redundant because the same check was already performed in the
   initialization loop above.

2. Add error logging for mt7925_mcu_add_bss_info() calls
   Several call sites were not checking return values. While failures
   in these paths often cannot be recovered from, logging helps with
   debugging. Added dev_warn() logging in:
   - beacon loss handler
   - sta removal path
   - link removal path
   - stop_ap
   - chanctx assign/unassign

3. Add missing NULL check for mconf in link removal
   mt792x_link_conf_to_mconf() can return NULL - add check before use.

Signed-off-by: Zac Bowling <zac@zacbowling.com>
---
 mt7925/main.c | 66 ++++++++++++++++++++++++++++++++++++++-------------
 mt7925/mcu.c  |  3 ---
 2 files changed, 49 insertions(+), 20 deletions(-)

--- a/mt7925/main.c
+++ b/mt7925/main.c
@@ -1248,11 +1248,17 @@ static void mt7925_mac_link_sta_assoc(st
 
 	if (link_conf && vif->type == NL80211_IFTYPE_STATION && !link_sta->sta->tdls) {
 		struct mt792x_bss_conf *mconf;
+		int ret;
 
 		mconf = mt792x_link_conf_to_mconf(link_conf);
-		if (mconf)
-			mt7925_mcu_add_bss_info(&dev->phy, mconf->mt76.ctx,
-						link_conf, link_sta, true);
+		if (mconf) {
+			ret = mt7925_mcu_add_bss_info(&dev->phy, mconf->mt76.ctx,
+						      link_conf, link_sta, true);
+			if (ret)
+				dev_warn(dev->mt76.dev,
+					 "failed to update BSS info during beacon loss (ret=%d)\n",
+					 ret);
+		}
 	}
 
 	ewma_avg_signal_init(&mlink->avg_ack_signal);
@@ -1320,16 +1326,21 @@ static void mt7925_mac_link_sta_remove(s
 
 	if (link_conf && vif->type == NL80211_IFTYPE_STATION && !link_sta->sta->tdls) {
 		struct mt792x_bss_conf *mconf;
+		int ret;
 
 		mconf = mt792x_link_conf_to_mconf(link_conf);
 		if (!mconf)
 			goto out;
 
-		if (ieee80211_vif_is_mld(vif))
+		if (ieee80211_vif_is_mld(vif)) {
 			mt792x_mac_link_bss_remove(dev, mconf, mlink);
-		else
-			mt7925_mcu_add_bss_info(&dev->phy, mconf->mt76.ctx, link_conf,
-						link_sta, false);
+		} else {
+			ret = mt7925_mcu_add_bss_info(&dev->phy, mconf->mt76.ctx,
+						      link_conf, link_sta, false);
+			if (ret)
+				dev_warn(dev->mt76.dev,
+					 "failed to remove BSS info (ret=%d)\n", ret);
+		}
 	}
 out:
 
@@ -1349,6 +1360,7 @@ mt7925_mac_sta_remove_links(struct mt792
 	struct mt76_dev *mdev = &dev->mt76;
 	struct mt76_wcid *wcid;
 	unsigned int link_id;
+	int ret;
 
 	/* clean up bss before starec */
 	for_each_set_bit(link_id, &old_links, IEEE80211_MLD_MAX_NUM_LINKS) {
@@ -1373,9 +1385,14 @@ mt7925_mac_sta_remove_links(struct mt792
 			continue;
 
 		mconf = mt792x_link_conf_to_mconf(link_conf);
+		if (!mconf)
+			continue;
 
-		mt7925_mcu_add_bss_info(&dev->phy, mconf->mt76.ctx, link_conf,
-					link_sta, false);
+		ret = mt7925_mcu_add_bss_info(&dev->phy, mconf->mt76.ctx,
+					      link_conf, link_sta, false);
+		if (ret)
+			dev_warn(dev->mt76.dev,
+				 "failed to remove link BSS info (ret=%d)\n", ret);
 	}
 
 	for_each_set_bit(link_id, &old_links, IEEE80211_MLD_MAX_NUM_LINKS) {
@@ -1985,8 +2002,11 @@ mt7925_stop_ap(struct ieee80211_hw *hw,
 	if (err)
 		goto out;
 
-	mt7925_mcu_add_bss_info(&dev->phy, mvif->bss_conf.mt76.ctx, link_conf,
-				NULL, false);
+	err = mt7925_mcu_add_bss_info(&dev->phy, mvif->bss_conf.mt76.ctx,
+				      link_conf, NULL, false);
+	if (err)
+		dev_warn(dev->mt76.dev,
+			 "failed to remove BSS info in stop_ap (ret=%d)\n", err);
 
 out:
 	mt792x_mutex_release(dev);
@@ -2357,6 +2377,7 @@ static int mt7925_assign_vif_chanctx(str
 	struct mt792x_dev *dev = mt792x_hw_dev(hw);
 	struct ieee80211_bss_conf *pri_link_conf;
 	struct mt792x_bss_conf *mconf;
+	int ret;
 
 	mutex_lock(&dev->mt76.mutex);
 
@@ -2370,9 +2391,14 @@ static int mt7925_assign_vif_chanctx(str
 		pri_link_conf = mt792x_vif_to_bss_conf(vif, mvif->deflink_id);
 
 		if (pri_link_conf && vif->type == NL80211_IFTYPE_STATION &&
-		    mconf == &mvif->bss_conf)
-			mt7925_mcu_add_bss_info(&dev->phy, NULL, pri_link_conf,
-						NULL, true);
+		    mconf == &mvif->bss_conf) {
+			ret = mt7925_mcu_add_bss_info(&dev->phy, NULL,
+						      pri_link_conf, NULL, true);
+			if (ret)
+				dev_warn(dev->mt76.dev,
+					 "failed to add BSS info in chanctx assign (ret=%d)\n",
+					 ret);
+		}
 	} else {
 		mconf = &mvif->bss_conf;
 	}
@@ -2393,6 +2419,7 @@ static void mt7925_unassign_vif_chanctx(
 	struct mt792x_vif *mvif = (struct mt792x_vif *)vif->drv_priv;
 	struct mt792x_dev *dev = mt792x_hw_dev(hw);
 	struct mt792x_bss_conf *mconf;
+	int ret;
 
 	mutex_lock(&dev->mt76.mutex);
 
@@ -2404,9 +2431,14 @@ static void mt7925_unassign_vif_chanctx(
 		}
 
 		if (vif->type == NL80211_IFTYPE_STATION &&
-		    mconf == &mvif->bss_conf)
-			mt7925_mcu_add_bss_info(&dev->phy, NULL, link_conf,
-						NULL, false);
+		    mconf == &mvif->bss_conf) {
+			ret = mt7925_mcu_add_bss_info(&dev->phy, NULL, link_conf,
+						      NULL, false);
+			if (ret)
+				dev_warn(dev->mt76.dev,
+					 "failed to remove BSS info in chanctx unassign (ret=%d)\n",
+					 ret);
+		}
 	} else {
 		mconf = &mvif->bss_conf;
 	}
--- a/mt7925/mcu.c
+++ b/mt7925/mcu.c
@@ -1377,9 +1377,6 @@ int mt7925_mcu_set_mlo_roc(struct mt792x
 		type = MT7925_ROC_REQ_JOIN;
 
 	for (i = 0; i < ARRAY_SIZE(links) && i < hweight16(vif->active_links); i++) {
-		if (!links[i].mconf || !links[i].chan)
-			return -ENOLINK;
-
 		chan = links[i].chan;
 		center_ch = ieee80211_frequency_to_channel(chan->center_freq);
 		req.roc[i].len = cpu_to_le16(sizeof(struct roc_acquire_tlv));
