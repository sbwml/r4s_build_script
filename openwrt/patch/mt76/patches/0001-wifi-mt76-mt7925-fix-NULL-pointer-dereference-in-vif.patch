From c0cffda0635828184cae6b8e2f91827deaff5062 Mon Sep 17 00:00:00 2001
From: Zac Bowling <zbowling@gmail.com>
Date: Wed, 31 Dec 2025 16:51:17 -0800
Subject: [PATCH 01/24] wifi: mt76: mt7925: fix NULL pointer dereference in vif
 iteration

Add NULL checks for bss_conf in all loops that iterate over valid_links
and call mt792x_vif_to_bss_conf(). This prevents kernel panics when the
link configuration in mac80211 is not yet set up even though the driver's
valid_links bitmap has the link marked as valid.

This can happen during HW reset when link state is inconsistent, or during
MLO operations where the driver's link tracking is ahead of mac80211's
BSS configuration.

Reported-by: Zac Bowling <zac@zacbowling.com>
Tested-by: Zac Bowling <zac@zacbowling.com>
Signed-off-by: Zac Bowling <zac@zacbowling.com>
---
 mt7925/mac.c  | 6 ++++++
 mt7925/main.c | 8 ++++++++
 2 files changed, 14 insertions(+)

--- a/mt7925/mac.c
+++ b/mt7925/mac.c
@@ -1276,6 +1276,12 @@ mt7925_vif_connect_iter(void *priv, u8 *
 		bss_conf = mt792x_vif_to_bss_conf(vif, i);
 		mconf = mt792x_vif_to_link(mvif, i);
 
+		/* Skip links that don't have bss_conf set up yet in mac80211.
+		 * This can happen during HW reset when link state is inconsistent.
+		 */
+		if (!bss_conf)
+			continue;
+
 		mt76_connac_mcu_uni_add_dev(&dev->mphy, bss_conf, &mconf->mt76,
 					    &mvif->sta.deflink.wcid, true);
 		mt7925_mcu_set_tx(dev, bss_conf);
--- a/mt7925/main.c
+++ b/mt7925/main.c
@@ -1312,6 +1312,8 @@ mt7925_mlo_pm_iter(void *priv, u8 *mac,
 	mt792x_mutex_acquire(dev);
 	for_each_set_bit(i, &valid, IEEE80211_MLD_MAX_NUM_LINKS) {
 		bss_conf = mt792x_vif_to_bss_conf(vif, i);
+		if (!bss_conf)
+			continue;
 		mt7925_mcu_uni_bss_ps(dev, bss_conf);
 	}
 	mt792x_mutex_release(dev);
@@ -1646,6 +1648,8 @@ static void mt7925_ipv6_addr_change(stru
 
 	for_each_set_bit(i, &valid, IEEE80211_MLD_MAX_NUM_LINKS) {
 		bss_conf = mt792x_vif_to_bss_conf(vif, i);
+		if (!bss_conf)
+			continue;
 		__mt7925_ipv6_addr_change(hw, bss_conf, idev);
 	}
 }
@@ -1886,6 +1890,8 @@ static void mt7925_vif_cfg_changed(struc
 	if (changed & BSS_CHANGED_ARP_FILTER) {
 		for_each_set_bit(i, &valid, IEEE80211_MLD_MAX_NUM_LINKS) {
 			bss_conf = mt792x_vif_to_bss_conf(vif, i);
+			if (!bss_conf)
+				continue;
 			mt7925_mcu_update_arp_filter(&dev->mt76, bss_conf);
 		}
 	}
@@ -1901,6 +1907,8 @@ static void mt7925_vif_cfg_changed(struc
 			} else if (mvif->mlo_pm_state == MT792x_MLO_CHANGED_PS) {
 				for_each_set_bit(i, &valid, IEEE80211_MLD_MAX_NUM_LINKS) {
 					bss_conf = mt792x_vif_to_bss_conf(vif, i);
+					if (!bss_conf)
+						continue;
 					mt7925_mcu_uni_bss_ps(dev, bss_conf);
 				}
 			}
